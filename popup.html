<html>
<head>
<script src='jquery-1.6.4.min.js'></script>
<script src='jquery.json-2.2.min.js'></script>
<link rel="stylesheet" type="text/css" href="style.css"/>
<link rel="shortcut icon" href="logo.gif" />
</head>
<body>
	<div id="title">Dossier</div>
	<div id="select-page-container">
		<div id="create-page-tab" class="page-selected">Make a List</div>
		<div id="view-page-tab">View Lists</div>
	</div>
	<div id="create-dossier-page">
		<span id="new-list-name">A New List</span> <!--<span id="edit-list-name">edit</span>-->
		<div id="selection-container">
			<span id="select-select">select</span> 
			<span id="select-all" class="selection-toggle">all</span> 
			<span id="select-none">none</span>
		</div>
		
		<div id="tab-container"></div>
		<div id="action-container">
			<span id="action-bundle-keep">Bundle Tabs (do NOT remove from window)
			</span>
			<div class="action" id="action-bundle">Bundle Tabs!</div>
		</div>
	</div>
	<div id="view-dossier-list-page">
		<div id="lists-container"></div>
	</div>
</body>
<script>

var windowTabs;
var curTabID;

$(document).ready(function(){

	$("#new-list-name").live("click",function(){
		var curListName = $(this).text();
		$(this).parent().prepend("<input id='input-list-name' value='"+curListName+"'/>");
		$("#input-list-name").focus();
		$(this).remove();
	})
	$("#input-list-name").live("keypress",function(e){
		if(e.which == 13){
			var curListName = $(this).attr("value");
			if(curListName == "") curListName = "New List";
			$(this).parent().prepend("<span id='new-list-name'>"+curListName+"</span>");
			$(this).remove();
			return false;
		}
	})
	
	if(localStorage.lists != undefined){
		$("#select-page-container").css("visibility","visible");
	}
	
	$("#new-list-name").click(function(){
		$("#input-list-name").removeClass("page-selected");
	})
	
	$("#input-list-name").click(function(){
		$("#new-list-name").removeClass("page-selected");
	})
	
<!--
	$("#edit-list-name").click(function(){
		if($("#edit-list-name").text() == "edit"){
			var curListName = $("#new-list-name").text();
			$("#new-list-name").parent().prepend("<input id='input-list-name' value='"+curListName+"'/>");
			$("#new-list-name").remove();
			$("#input-list-name").focus();
			$("#edit-list-name").text("done");
		}
		if($("#edit-list-name").text() == "done"){
			var curListName = $("#input-list-name").attr("value");
			$("#input-list-name").parent().prepend("<span id='new-list-name'>"+curListName+"</span>");
			$("#input-list-name").remove();
			$("#edit-list-name").text("edit");
		}
	})
-->

	chrome.windows.getCurrent(function(window){
		console.log(window);
		
		chrome.tabs.getSelected(window.id,function(t){
			console.log(t);
			curTabID = t.id;
		
			chrome.tabs.getAllInWindow(window.id,function(tabs){
				windowTabs = tabs.slice(0);
				tabs.forEach(function(tab){
					if(tab.url.indexOf("chrome://") && tab.url != ""){
			    		var tabDiv = '<div id="tab-'+tab.index+'" class="tab-element"><img class="tab-favicon" src="'+tab.favIconUrl+'"/>'+tab.title.substring(0,50)+
			    		(tab.title.length > 50 ? '...': '')+'<img src="check.png" class="check"/></div>';
			    		$("#tab-container").append(tabDiv);
			    	} 
		  		});

		  		$(".tab-element").bind("click",function(){
					$("#select-all").removeClass("selection-toggle");
					$("#select-none").removeClass("selection-toggle");

					if($(this).hasClass("selected")){ 
						$(this).removeClass("selected");
						$(this).find(".check").css("display","none");
					} else {
					 	$(this).addClass("selected");
					 	$(this).find(".check").css("display","block");
					}
					checkSelectedTabs();
				})

		  		$(".tab-element").addClass("selected");
			});
		});
		
	})

	

	$("#select-all").click(function(){
		$(this).addClass("selection-toggle");
		$("#select-none").removeClass("selection-toggle");
		$(".tab-element").each(function(){
			$(this).addClass("selected");
			$(this).find(".check").css("display","block");
		});
		checkSelectedTabs();
	})
		
	$("#select-none").click(function(){
		$(this).addClass("selection-toggle");
		$("#select-all").removeClass("selection-toggle");
		$(".tab-element").each(function(){
			$(this).removeClass("selected");
			$(this).find(".check").css("display","none");
		});
		checkSelectedTabs();
	})

	function checkSelectedTabs(){
		if($(".selected").length > 0){
			$("#action-bundle").css("opacity",1);
			$("#action-bundle-keep").css("opacity",1);
		} else {
			$("#action-bundle").css("opacity",0.5);
			$("#action-bundle-keep").css("opacity",0.5);
		}
	}

	$("#action-bundle-keep").click(function(){
		sendTabsToCollection(false);
	})

	$("#action-bundle").click(function(){
		sendTabsToCollection(true);
	});

	function sendTabsToCollection(removeFromWindow){
		if($(".selected").length > 0){
			var tabsChecked = 0;
			var tabsCaptured = Array();
			
			for(var i=0;i<windowTabs.length;i++){
				var tab = windowTabs[i];
				
				if($("#tab-"+tab.index+"").hasClass("selected")){
					//stringToEmail += windowTabs[i].title + encodeURIComponent("\n") + windowTabs[i].url + encodeURIComponent("\n\n");
					tabsCaptured.push(windowTabs[i]);
					tabsChecked++; 
				}
			}
			if(tabsChecked > 0){
				var titleOfList = $("#new-list-name").text();
				if(titleOfList == "") titleOfList = $("#input-list-name").text()
			
				openTabsInNewTab(titleOfList, tabsCaptured, removeFromWindow);
			} 
		}
	}
	
	function openTabsInNewTab(listTitle, tabsToList, removeFromWindow){
		chrome.tabs.create({ url: "dossier_collection.html" },function(tab){
			
			var newListElement = {title:listTitle, tabs: tabsToList};
			if(localStorage.lists == undefined) localStorage.lists = new Array();	
			localStorage.lists.push(newListElement);
			
			chrome.tabs.sendRequest(tab.id,newListElement, function(response) {
					// console.log(response.success);
			});
			
			if(removeFromWindow) {
				tabsToList.forEach(function(tabCap){
					chrome.tabs.remove(tabCap.id,function(){
						console.log("Tab Removed: "+tabCap.index);
					});
				});
			}
			self.close();
			//chrome.tabs.executeScript(tab.id,"updateContents("+$.toJSON(tabsCaptured)+")");
		});
	}

})

</script>
</html>