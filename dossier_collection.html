<html>
<head>
<title>New Dossier List</title>
<script src='jquery-1.6.4.min.js'></script>
<script src='jquery.json-2.2.min.js'></script>
<link rel="stylesheet" type="text/css" href="style.css"/>
<link rel="shortcut icon" href="logo.gif" />
</head>
<body>
	<div id="title">Dossier: New List</div>
	<div id="dossier-tabs-saved-container"></div>
	<div id="action-container">
		<div class="action" id="action-email">Email It</div>
		<div class="action" id="action-restore">Restore Tabs</div>
		<a href="" id="action-email-sendto">&nbsp;</a>
	</div>
	<div id="remove-list-button">Delete This List</div>
	<div id="remove-list-popover">
		<div id="remove-confirmation"><strong>Delete this List</strong> Are you sure? This cannot be undone.</div>
		<div id="remove-button-yes">Yes, I'm sure.</div>
		<div id="remove-button-no">No, thanks.</div>
	</div>
</body>
<script>

var tabs;
var thisID;
var curTabID;
var localStorageObj;

chrome.windows.getCurrent(function(window){
	//console.log(window);
	
	chrome.tabs.getSelected(window.id,function(t){
		//console.log(t);
		curTabID = t.id;
	});
});

$(document).ready(function(){

	$("#remove-list-button").click(function(){
		$("#remove-list-popover").slideDown();
	})
	$("#remove-button-yes").click(function(){
		console.log("Send Local Storage Request");
		chrome.extension.sendRequest({method: "getLocalStorage"}, function(response) {
			console.log(response);

			if(response.data != "" && response.data != "undefined") {
				localStorageObj = JSON.parse(response.data);

				delete localStorageObj.lists[thisID];

				chrome.extension.sendRequest({method: "setLocalStorage",data:localStorageObj}, function(response) {
			  			console.log(response);
			  			chrome.tabs.remove(curTabID,function(){ })
			  		}
			  	);
			}
		});
	});
	$("#remove-button-no").click(function(){
		$("#remove-list-popover").slideUp();
	});

	$("#action-email").click(function(){
		
		var stringToEmail = "mailto: ?subject=Dossier Link List";
		stringToEmail += "&body=Links gathered for you:" + 
			encodeURIComponent("\n") + "--------------------------" + encodeURIComponent("\n\n");
		
		tabs.forEach(function(tab){
			stringToEmail += encodeURIComponent(tab.title) + encodeURIComponent("\n") +
			encodeURIComponent(tab.url) + encodeURIComponent("\n\n");	
		});
		window.location.href = stringToEmail;
	})
	
	$("#action-restore").click(function(){
		tabs.forEach(function(tab){
			console.log(tab);
			var tabInfo = {};
			tabInfo.url = tab.url;
			tabInfo.selected = false;
			chrome.tabs.create(tabInfo, function(){ });
		});
	})

});


chrome.extension.onRequest.addListener(
	function(request, sender, sendResponse) {
		if(request.method == "newTab"){
			if (request.tabs.length > 0){
				sendResponse({success: true});
				tabs = request.tabs.slice(0);
				thisID = request.date;
				console.log(thisID);

				$("#title").text("Dossier: "+request.title);
				document.title = request.title;

				request.tabs.forEach(function(tab){
					var tabDiv = '<div class="tab-element-collection"><img class="tab-favicon" src="'
					+ tab.favIconUrl+'"/>'+
					tab.title+'<a href="'+tab.url+'" target="_blank">link</a></div>';

					$("#dossier-tabs-saved-container").append(tabDiv);

				});
			} else {
		  		sendResponse({success: false, error: "no tabs selected"}); 
		  	}
		}
});


</script>
</html>